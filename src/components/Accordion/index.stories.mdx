import { useState } from 'react';
import { Canvas, Meta, Story, ArgsTable, Source } from '@storybook/addon-docs';
import { Accordion, DEFAULT_EASING, DEFAULT_DURATION } from './index.tsx';
import { ChevronDownIcon, HeartFillIcon } from '../../assets/Icon';
import { generateTable } from '../../storybook-props';
import { runTest } from './storybookTest.ts';
import { css } from '@emotion/react';
import {
  black,
  bluescale50,
  bluescale100,
  grayscale200,
  grayscale600,
  grayscale800,
  grayscale900,
} from '../../core/colors';
import { spacing } from '../../core';
import dedent from 'ts-dedent';

<Meta
  title="Components/Accordion"
  subcomponents={{
    'Accordion.Indicator': Accordion.Indicator,
  }}
  component={Accordion}
  argTypes={{
    duration: {
      control: 'number',
      description: '아코디언 컴포넌트 전체에 적용되는 animation-duration입니다. 단위는 millisecond 입니다.',
      ...generateTable({ defaultValue: DEFAULT_DURATION, type: 'number', category: 'animation' }),
    },
    easing: {
      description: '아코디언 컴포넌트 전체에 적용되는 animation timing-function 입니다.',
      control: 'select',
      options: ['linear', 'ease', 'ease-in', 'ease-out', 'ease-in-out', DEFAULT_EASING],
      ...generateTable({ defaultValue: DEFAULT_EASING, type: 'string', category: 'animation' }),
    },
    type: {
      control: 'radio',
      options: ['fill', 'line', undefined],
      description: '로플랫 UI가 정한 스타일 바리에이션을 적용합니다.',
      ...generateTable({ category: 'style' }),
    },
    css: {
      control: 'null',
      ...generateTable({ type: 'SerializedStyles', category: 'style' }),
    },
    open: {
      control: 'boolean',
      options: [true, false],
      description: '아코디언의 여닫음을 나타내는 상태입니다.',
      ...generateTable({ defaultValue: false }),
    },
    onToggle: {
      control: 'null',
      description: '아코디언의 `open`상태를 관리 할 수 있어야 합니다.',
      ...generateTable({ defaultValue: undefined }),
    },
  }}
/>

export const title = '새겨지는 별이 이름을 된 이웃 거외다.';
export const content =
  '딴은 당신은 흙으로 가득 까닭이요, 아침이 프랑시스 이름자를 거외다. 노새, 불러 그러나 토끼, 무엇인지 아이들의 소녀들의 이름을 나의 듯합니다. 계절이 나는 언덕 한 너무나 별 별 책상을 봅니다. 가을로 밤을 가을 나의 이름과, 부끄러운 하나에 옥 까닭입니다. 슬퍼하는 겨울이 내 어머니 멀리 별을 이제 계십니다. 사람들의 지나가는 다하지 하나의 했던 내린 듯합니다. 이제 가을 지나고 시인의 위에 별을 하나에 있습니다.';

export const Template = (args) => (
  <Accordion {...args}>
    <Accordion.Title>
      {title}
      <Accordion.Indicator>
        <ChevronDownIcon size={12} />
      </Accordion.Indicator>
    </Accordion.Title>
    <Accordion.Content>{content}</Accordion.Content>
  </Accordion>
);

# Accordion

**열림 상태**일 때만 상세 정보를 보여주는 컴포넌트입니다.

요약이나 레이블은 `Accordion.Title` 컴포넌트, 상세 정보는 `Accordion.Content` 컴포넌트 자식에 작성해주세요.

`open`과 `onToggle`을 할당하여 **직접 조작**하거나, 전달하지 않아도 **전달하지 않아도 독립적으로 여닫을 수 있습니다.**

<br />
<br />

## 예제

### 기본형

아래 컴포넌트는 `open`과 `onToggle`을 전달하지 않았지만 동일하게 움직입니다.

<Canvas>
  <Story name="default">{runTest(Template.bind({}))}</Story>
</Canvas>

<ArgsTable story="default" />

<br />

### 컨트롤 컴포넌트

아래의 예제는 아코디언의 상태와 상태관리를 코드작성자에게 완전히 맡깁니다.

<Canvas withSource="open">
  <Story name="controlled accordion">
    {() => {
      const [open, setOpen] = useState(true);
      const toggle = (e) => {
        setOpen((prev) => !prev);
        console.log('Hi from Accordion');
      };
      return (
        <Accordion open={open} onToggle={toggle} type="line">
          <Accordion.Title headingLevel={'h4'}>
            {title}
            <Accordion.Indicator>
              <ChevronDownIcon size={12} />
            </Accordion.Indicator>
          </Accordion.Title>
          <Accordion.Content>{content}</Accordion.Content>
        </Accordion>
      );
    }}
  </Story>
</Canvas>

<br />

### 사용자 정의 스타일

스타일은 아래와 같은 형식으로 작성해서 `Accordion` 컴포넌트의 `css` 속성으로 넘겨주세요.

**type 속성을 추가하지 않아야** 손쉽게 구현할 수 있습니다.

export const anotherStyle = css`
  border: 1px solid ${grayscale200};
  border-radius: 5px;
  &.expanded {
    background-color: ${bluescale50};
    summary {
      background-color: inherit;
      color: ${grayscale900};
    }
  }
  summary {
    color: ${grayscale900};
    background-color: ${bluescale50};
    > div {
      padding: ${spacing(8)}px ${spacing(6)}px;
    }
    h3 {
      font-weight: bold;
    }
    & ~ * {
      background-color: ${bluescale50};
      > div {
        padding: ${spacing(8)}px ${spacing(6)}px;
      }
    }
    &:hover,
    &:focus {
      background-color: ${bluescale100};
    }
  }
`;

<Canvas>
  <Story name="custom style" withSource="none">
    <Accordion css={anotherStyle}>
      <Accordion.Title>
        {title}
        <Accordion.Indicator keyframes={[{ transform: 'rotate(0deg)' }, { transform: 'rotate(90deg)' }]}>
          <ChevronDownIcon size={24} fillColor={grayscale600} />
        </Accordion.Indicator>
      </Accordion.Title>
      <Accordion.Content>{content}</Accordion.Content>
    </Accordion>
  </Story>
</Canvas>

<Source
  language="jsx"
  dark
  format={false}
  code={dedent`
  import { css } from '@emotion/react';
  import { Accordion } from 'loplat-ui';
  
  const anotherStyle = css\`
    border: 1px solid ${grayscale200};
    border-radius: 5px;
    &.expanded { 
      background-color: ${bluescale50};
      summary {
        background-color: inherit;
        color: ${grayscale900};
      }
    }
    summary {
      color: ${grayscale900};
      background-color: ${bluescale50};
      > div {
        padding: ${spacing(8)}px ${spacing(6)}px;
      }
      h3 {
        font-weight: bold;
      }
      & ~ * {
        /* Accordion.Content */ 
        background-color: ${bluescale50};
        > div {
          padding: ${spacing(8)}px ${spacing(6)}px;
        }
      }
      &:hover, &:focus {
        background-color: ${bluescale100};
      }
    }
  \`
  
  function CustomAccordionExample(){
    return (
      <Accordion css={anotherStyle}>
        <Accordion.Title>
          ${title}
          <Accordion.Indicator keyframes={[{ transform: 'rotate(0deg)' }, { transform: 'rotate(90deg)' }]}>
            <ChevronDownIcon size={24} />
          </Accordion.Indicator>
        </Accordion.Title>
        <Accordion.Content>${content}</Accordion.Content>
      </Accordion>
  )}
  `}
/>

<br />

## `<Accordion.Indicator />`

`Accordion.Indicator` 컴포넌트는 여닫힘 상태를 추측할 수 있는 아이콘을 표시할 수 있습니다.

아코디언에 아이콘이 필요하지 않다면, `<Accordion.Title/>`에 `<Accordion.Indicator/>`를 넣지 않으면 됩니다.

<Canvas>
  <Story name="without icon">
    <Accordion type="fill">
      <Accordion.Title>{title}</Accordion.Title>
      <Accordion.Content>{content}</Accordion.Content>
    </Accordion>
  </Story>
</Canvas>

### 아이콘의 위치는 작성한 순서로 결정됩니다.

아이콘을 타이틀 상단에 위치시키고 싶다면 `<Accordion.Indicator/>` 을 첫번째 자식으로 작성하세요.

만약 `<Accordion.Title/>` 의 자식 중, `<Accordion.Indicator/>`의 순서가 첫번째가 아니라면, 아이콘은 항상 오른쪽 끝에 위치합니다.

<Canvas>
  <Story name="icon position-end">
    <Accordion type="fill">
      <Accordion.Title>
        <div>Accordion.Title의 첫번째 자식이 Accordion.Indicator컴포넌트가 아니라면, 아이콘은 오른쪽에 위치합니다.</div>
        <Accordion.Indicator
          keyframes={[
            { transform: 'rotate(0deg) scale(1)' },
            { transform: 'scale(0.8)' },
            { transform: 'rotate(90deg) scale(1)' },
          ]}
        >
          <HeartFillIcon size={20} fillColor="red" />
        </Accordion.Indicator>
      </Accordion.Title>
      <Accordion.Content>{content}</Accordion.Content>
    </Accordion>
  </Story>
</Canvas>

### 아이콘에 커스텀 애니메이션을 전달하세요.

색다른 애니메이션을 주고싶다면 `keyframes` 속성을 이용하세요. 해당 속성은 `keyframes 객체 리스트`를 받습니다.

<Canvas withSource="open">
  <Story name="custom icon animation">
    <Accordion open={true} type="fill">
      <Accordion.Title>
        <Accordion.Indicator
          keyframes={[
            { transform: 'rotate(0deg) scale(1)' },
            { transform: 'scale(0.8)' },
            { transform: 'rotate(-90deg) scale(1)' },
          ]}
        >
          <HeartFillIcon size={20} fillColor="red" />
        </Accordion.Indicator>
        {title}
      </Accordion.Title>
      <Accordion.Content>{content}</Accordion.Content>
    </Accordion>
  </Story>
</Canvas>

<br />

## 웹 접근성

예제의 node tree hierarchy 를 정확하게 준수한다면, 접근성을 높이기 위한 코드는 추가적으로 작성하지 않아도 충분합니다.

웹 표준을 지키기 위해 아코디언 컴포넌트는 `summary`, `details` 태그로 작성되었습니다.

<br />

## 주의사항

`Accordion` 의 자식으로 `Accordion.Title`, `Accordion.Content` 을 **필수로 넣어줘야 정상적으로 동작**합니다.

그렇지 않으면 `DOMException` 에러가 발생합니다.

아래 예제는 `Accordion.Content`을 넣지 않은 코드입니다.
언뜻 보면 정상적으로 렌더링 된 것 같지만 타이틀을 클릭하면 `DOMException` 에러가 발생하고, 내용이 보이지 않습니다.

<Canvas withSource="open">
  <Story name="wrong usuage">
    <Accordion type="line">
      <Accordion.Title>{title}</Accordion.Title>
      <div>Accordion.Content 태그를 쓰지않으면 렌더링 되지 않습니다.</div>
    </Accordion>
  </Story>
</Canvas>
